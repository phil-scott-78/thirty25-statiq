@{
    Layout = null;
}
@inherits StatiqRazorPage<Statiq.Common.IDocument>

<!DOCTYPE html>
<html lang=" en" class="no-js">
<head>
    <title>@Document.GetString("Title")</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width">

    <script src="https://unpkg.com/pagedjs/dist/paged.polyfill.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>

    <link href="https://fonts.googleapis.com/css2?family=Raleway:wght@800;900&family=Roboto+Slab:wght@100;200;300;400;500;600;700;800;900&family=Source+Code+Pro:wght@300;400" rel="stylesheet">
    <style>
        @@media print{
            html { font-size: 62.5%; } 
        
            body {
                font-family: 'Roboto Slab', serif;
                font-size: 1.35rem;
            }
            
            h1, h2, h3, h4, h5 {
                font-family: 'Raleway', sans-serif;
            }
            
            /* Box sizing rules */
            *,
            *::before,
            *::after {
              box-sizing: border-box;
            }
            
            /* Remove default margin */
            body,
            h1,
            h2,
            h3,
            h4,
            p,
            figure,
            blockquote,
            dl,
            dd {
              margin: 0;
            }
            
            /* Remove list styles on ul, ol elements with a list role, which suggests default styling will be removed */
            ul[role='list'],
            ol[role='list'] {
              list-style: none;
            }
            
            /* Set core root defaults */
            html:focus-within {
              scroll-behavior: smooth;
            }
            
            /* Set core body defaults */
            body {
              min-height: 100vh;
              text-rendering: optimizeLegibility;
              line-height: 1.6;
            }
            
            /* A elements that don't have a class get default styles */
            a:not([class]) {
              text-decoration-skip-ink: auto;
            }
            
            /* Make images easier to work with */
            img,
            picture {
              max-width: 100%;
              display: block;
            }
            
            /* Inherit fonts for inputs and buttons */
            input,
            button,
            textarea,
            select {
              font: inherit;
            }
            
            .visually-hidden {
              clip: rect(0 0 0 0);
              clip-path: inset(100%);
              height: 1px;
              overflow: hidden;
              position: absolute;
              width: 1px;
              white-space: nowrap;
            }
            
            h1 {
                font-size: 3rem;
                font-weight: 900;
                line-height: 3.1rem;
                string-set: title content(text);
                margin-bottom:  1rem;
            }
            
            h2, h3, h4, h5 {
              margin-top: 1.5rem;
              margin-bottom: .75rem;
            }
            
            pre, code {
                font-family: 'Source Code Pro', monospace;
            }
                       
            @@page:left{
               @@top-left {
                  content: counter(page);
               }
               
             @@top-center {
               content: string(title);
               font-size:.9rem;
             }  
            }
        
            @@page:right{
                @@top-right {
                  content: counter(page);
                }
                
                              
              @@top-center {
                content: 'Thirty25.com';
                font-size:.9rem;
              }  
            }
        
            @@page:blank {
                @@top-center {
                    content: none;
                }
            }
            
            @@page:first {
                @@top-center {
                    content: none;
                }
                            
                @@top-right {
                  content: none;
                }
                
               @@top-left {
                  content: none;
               }
            }
        
            @@page {
                size: letter;
                margin: 10mm 15mm;
                bleed: 6mm;
            }
            
            .footnote {
              float: footnote;
            }
            
            @@page {
              @@footnote {
                float: bottom;
                font-size:1rem;
              }
            }
            
            #title {
                break-after: right;       
                display:  flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;  
                height:100%;
            }
            
            #title h1{
                font-size: 6rem;
            }
            
            #title h2{
                font-size: 3rem;
                font-weight: 200;
            }
            
            .chapter{
                break-before: right;
                height: 100%;
            }
            
            .chapter header {
                break-before: right;       
                display:  flex;
                flex-direction: column;
                justify-content: center;  
                height:100%;
            }
            
            .chapter header h1 {
                font-size: 4rem;
                line-height: 4rem;
                font-weight: 800;
            }
            
            .chapter header .desc {
                font-size: 1.5rem;
                font-weight: 300;
            }
            
            .chapter pre {
                font-size: 1rem;
                line-height: 1.45rem;
                letter-spacing: -0.025rem;
                overflow-x: auto;
                white-space: pre-wrap;
                word-wrap: break-word;
                margin: 2rem 0;
                padding: .25rem 0 .25rem 1rem;
                border-left:  4px solid #666;
                page-break-inside:avoid;
            }
            
            .chapter p {
                margin-top:  1rem;
                margin-bottom:  1rem;
            }
            
            .chapter a{
                text-decoration: none;;
            }
                        
            .chapter table {
                width: 100%;
                table-layout: auto;
                text-align: left;
                margin-top: 2em;
                margin-bottom: 2em;
                font-size: 0.875em;
                line-height: 1.7142857;
                page-break-inside:avoid;
                border-collapse: collapse
            }
            
            .chapter table thead tr{
                border-bottom: 1px solid #666;
            }
            
            .chapter table tbody tr{
                border-bottom: 1px solid #ccc;
            }
            
            .chapter table tbody tr:last-child{
                border-bottom: none;
            }
            
            #toc, #toc ol {
                list-style-type: none;
                line-height: 3rem;
            }
            
            #toc {
                padding: 0;
            }
            
            #toc > li > div {
                font-weight: bold;
            }
                                   
            #toc ol {
                padding-inline-start: 3ch;
            }
                       
            #toc li > div {
              display: grid;
              grid-template-columns: auto max-content;
              align-items: end;
            }
                       
            #toc li .title{
                position: relative;
                overflow: hidden;
            }
            
            #toc li .title::after {
                position: absolute;
                padding-left: .25ch;
                content: " . . . . . . . . . . . . . . . . . . . "
                    ". . . . . . . . . . . . . . . . . . . . . . . "
                    ". . . . . . . . . . . . . . . . . . . . . . . "
                    ". . . . . . . . . . . . . . . . . . . . . . . "
                    ". . . . . . . . . . . . . . . . . . . . . . . "
                    ". . . . . . . . . . . . . . . . . . . . . . . "
                    ". . . . . . . . . . . . . . . . . . . . . . . ";
                text-align: right;
                color: #666;
            }
            
            #toc li .page{
              text-align: right;
            }
            
            #toc li a{
              color: inherit;
              text-decoration: none;
            }   
            
            #toc li a::after{
              content: target-counter(attr(href), page);
              font-variant-numeric: tabular-nums;
              min-width: 3ch;
              text-align: right;
              margin-left: .5rem;
            }   
        }
        

    </style>
</head>
@{
    var allChildren = Document.GetChildren().ToArray();

}

<body>
<section id="title">
    <header>
        <h1>Phil Scott</h1>
        <h2>The Computer Files (Unexpurgated)</h2>    
    </header>
</section>

<h1>Table of Contents</h1>
<div>
    <ol id="toc">
    @foreach (var doc in allChildren)
     {
         IReadOnlyList<IDocument> headings = doc
             .GetDocumentList(Keys.Headings)
             .ToList();
         <li>
             <div>
             <span class="title">@doc.GetString("Title")</span>
             <span class="page"><a href="@("#id" + doc.Id)"><span class="visually-hidden">Page </span></a></span>
             </div>
             @if (headings?.Count > 0)
             {
                 <ol>
                     @foreach (var heading in headings)
                     {
                         <li>
                             <div>
                                <span class="title">@(await heading.GetContentStringAsync())</span>
                                <span class="page"><a href="#@(heading.GetString(Keys.HeadingId))"><span class="visually-hidden">Page </span></a></span>
                             </div>
                         </li>
                     }
                 </ol>
             }
         </li>
     }
    </ol>
</div>

@foreach (var doc in allChildren)
{
    {
        var content = await doc.GetContentStringAsync();
        <section class="chapter">
            <header>
                <h1 id="@("id" + doc.Id)" class="title-element" data-title-level="h1">@doc.GetString("Title")</h1>
                <p class="desc">Originally published @doc.GetDateTime("date").ToLongDateString()</p>
            </header>
            @Html.Raw(content)
        </section>
    }
}

<script>
  // when rendering we need to know how long to wait until saving as a pdf
  // paged.js can be pretty slow, especially running in a GH action, so
  // we'll send a console message that playwright will wait for. 
  class MyHandler extends Paged.Handler {
    constructor(chunker, polisher, caller) {
      super(chunker, polisher, caller);
    }

    afterRendered(pages) {
      console.log("after render");
    }
  }
  Paged.registerHandlers(MyHandler);
</script>

</body>
</html>